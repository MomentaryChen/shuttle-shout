# ShuttleShout 人員權限說明

本文件說明目前系統的人員（用戶）與權限設計，包含角色、頁面資源與權限檢查方式。

---

## 一、整體架構

權限採用 **RBAC（Role-Based Access Control）** 概念：

- **用戶（User）**：登入系統的人員，可被指派多個角色。
- **角色（Role）**：一組權限的集合，例如系統管理員、球員。
- **頁面資源（Resource Page）**：系統內的功能頁面（如人員配置管理、球隊管理等）。
- **角色－頁面權限**：每個角色對每個頁面資源可擁有 **讀取（read）**、**寫入（write）**、**刪除（delete）** 三種權限。

關係簡述：

- 用戶 ↔ 角色：多對多（`user_roles`）。
- 角色 ↔ 頁面資源：多對多，並帶權限欄位（`role_resource_pages`：`can_read`、`can_write`、`can_delete`）。

---

## 二、資料表結構

| 表名 | 說明 |
|------|------|
| `users` | 用戶基本資料（帳號、密碼、是否啟用等） |
| `roles` | 角色定義（名稱、代碼、描述、是否啟用） |
| `user_roles` | 用戶與角色的關聯（一用戶可多角色） |
| `resource_pages` | 頁面資源（名稱、代碼、路徑、排序等） |
| `role_resource_pages` | 角色與頁面資源的關聯及權限（can_read / can_write / can_delete） |

---

## 三、預設角色

初始化資料中定義了四種角色（見 `data/3. roles_init_data.sql`）：

| 代碼 (code) | 名稱 | 說明 |
|-------------|------|------|
| `SYSTEM_ADMIN` | 系統管理員 | 擁有所有權限 |
| `TEAM_ADMIN` | 團隊管理員 | 管理團隊相關權限 |
| `TEAM_MANAGER` | 團隊經理 | 管理團隊日常事務 |
| `PLAYER` | 球員 | 一般使用者 |

在 Spring Security 中，角色會以 **`ROLE_` + 大寫 code** 的形式出現（例如 `ROLE_SYSTEM_ADMIN`、`ROLE_PLAYER`）。

---

## 四、頁面資源與預設權限

頁面資源定義於 `data/2. resource_pages_init_data.sql`，目前包含：

| 代碼 (code) | 名稱 | 路徑 |
|-------------|------|------|
| `TEAM_OVERVIEW` | 團隊總覽 | `/` |
| `PERSONNEL_MANAGEMENT` | 人員配置管理 | `/personnel-management` |
| `TEAM_MANAGEMENT` | 球隊管理 | `/team-management` |
| `COURT_MANAGEMENT` | 球場管理 | `/court-management` |
| `QUEUE_SYSTEM` | 排隊叫號系統 | `/queue-system` |
| `MATCH_MANAGEMENT` | 比賽管理系統 | `/match-management` |
| `STATISTICS_REPORT` | 統計報表 | `/statistics` |
| `SYSTEM_SETTINGS` | 系統設定 | `/system-settings` |

初始化資料中，角色與頁面的對應大致為：

- **系統管理員 (role_id=1)**：人員配置管理、球隊管理、排隊叫號、比賽管理、統計報表、系統設定（多為 read/write/delete 全開）。
- **球員 (role_id=4)**：團隊總覽（僅 read）、球隊管理（read/write/delete）。

其餘角色（TEAM_ADMIN、TEAM_MANAGER）的頁面權限可透過後台或資料庫的 `role_resource_pages` 調整。

---

## 五、權限類型（頁面維度）

每個「角色－頁面」關聯可設定三種權限：

| 權限 | 欄位 | 說明 |
|------|------|------|
| 讀取 | `can_read` | 是否可查看該頁面／資料 |
| 寫入 | `can_write` | 是否可編輯／新增 |
| 刪除 | `can_delete` | 是否可刪除 |

後端檢查時會依 `resourcePageCode` 與 `permission`（read / write / delete）判斷當前用戶是否具備該權限。

---

## 六、後端如何判斷權限

### 6.1 登入時載入角色

- `CustomUserDetailsService` 依用戶 ID 或用戶名載入用戶，並從關聯的 `roles` 取得角色 **code**。
- 每個角色的 code 會轉成 Spring Security 的 **Authority**：`ROLE_` + 大寫 code（如 `ROLE_PLAYER`）。
- 若用戶沒有任何角色，會預設加上 `ROLE_USER`。

因此「是否具備某角色」可用 Spring 的 `hasRole("SYSTEM_ADMIN")` 等語法判斷（底層即 `ROLE_SYSTEM_ADMIN`）。

### 6.2 頁面資源權限檢查

- **ResourcePageService.hasPermission(userId, resourcePageCode, permission)**  
  - 依 `userId` 取得該用戶所有角色。  
  - 再依 `resourcePageCode` 與這些角色，查詢 `role_resource_pages`。  
  - 依 `permission`（read / write / delete）對應的 `can_read` / `can_write` / `can_delete` 判斷是否至少有一個角色具備該權限。

- API：`GET /api/resource-pages/check-permission/{resourcePageCode}/{permission}`  
  - 會使用當前登入用戶的 ID 呼叫上述邏輯，回傳是否擁有該頁面的該權限。

### 6.3 取得當前用戶可訪問的頁面

- **ResourcePageService.getResourcePagesByUserId(userId)**  
  - 依用戶的角色，彙總所有在 `role_resource_pages` 中有設定的頁面資源，用於選單或前端的頁面可見性。

### 6.4 工具方法（SecurityUtil）

- `SecurityUtil.hasRole(roleCode)`：當前用戶是否擁有指定角色（如 `"SYSTEM_ADMIN"`）。
- `SecurityUtil.hasAnyRole(roleCodes...)`：當前用戶是否擁有任一指定的角色。
- `SecurityUtil.getCurrentUsername()`：當前登入者名稱（實際為用戶 ID 字串）。
- `SecurityUtil.isAuthenticated()`：是否已認證。

---

## 七、安全配置（SecurityConfig）概觀

- 登入、註冊、健康檢查、Swagger、WebSocket、部分 GET（如 `/teams`）等為 **permitAll**，無需登入。
- **其餘 API** 皆需通過 JWT 認證（`anyRequest().authenticated()`）。
- 未依 URL 區分角色；頁面級權限依上述 **角色 ＋ 頁面資源 ＋ read/write/delete** 在業務層（如 Controller 呼叫 `resourcePageService.hasPermission`）或前端依 API 回傳結果控制。

---

## 八、前端如何配合

- 登入後可呼叫 **取得當前用戶可訪問的頁面** 的 API，用來渲染側邊選單或路由可見性。
- 對需要精細控制的操作（例如按鈕的編輯/刪除），可再呼叫 **check-permission** API（`/api/resource-pages/check-permission/{resourcePageCode}/{permission}`）決定是否顯示或啟用。

---

## 九、相關檔案索引

| 類型 | 路徑 |
|------|------|
| Schema | `data/1. shuttleshout_schema.sql` |
| 角色初始資料 | `data/3. roles_init_data.sql` |
| 頁面資源與角色－頁面權限初始資料 | `data/2. resource_pages_init_data.sql` |
| 安全設定 | `src/main/java/.../config/SecurityConfig.java` |
| 用戶權限載入 | `src/main/java/.../security/CustomUserDetailsService.java` |
| 權限工具 | `src/main/java/.../common/util/SecurityUtil.java` |
| 頁面資源與權限服務 | `src/main/java/.../service/impl/ResourcePageServiceImpl.java` |
| 頁面資源 API | `src/main/java/.../controller/ResourcePageController.java` |
| 角色 API | `src/main/java/.../controller/RoleController.java` |
| 角色－頁面權限 API | `src/main/java/.../controller/RoleResourcePageController.java` |

---

以上為目前人員權限的設計與實作說明；實際角色與頁面對應請以資料庫與初始化 SQL 為準，若有新增頁面或角色，需在 `resource_pages` 與 `role_resource_pages` 中維護。
