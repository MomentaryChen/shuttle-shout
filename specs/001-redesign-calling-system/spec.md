# Feature Specification: 叫號系統重新設計與結束流程修正

**Feature Branch**: `001-redesign-calling-system`  
**Created**: 2025-02-13  
**Status**: Draft  
**Input**: User description: "我要重新設計一下叫號系統，現在系統有明顯的叫號bug存在，並且按下結束，應該直接離開叫號系統頁面"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 按下「結束」後直接離開叫號系統頁面 (Priority: P1)

管理員在團隊叫號系統頁面中，當已連線至叫號服務時，點擊「結束」按鈕後，系統應結束當前叫號連線並**立即離開叫號系統頁面**，回到上一頁或指定入口，而不是僅斷線仍停留在同一頁。

**Why this priority**: 使用者明確要求此行為，且目前「結束」僅斷線不離開，造成認知與操作不一致，影響最大。

**Independent Test**: 進入叫號系統頁並連線後，點擊「結束」→ 應離開該頁面（例如回到團隊或首頁），可單獨驗證導向與離開行為。

**Acceptance Scenarios**:

1. **Given** 使用者已在叫號系統頁面且已連線，**When** 點擊「結束」按鈕，**Then** 系統結束連線並導向離開叫號系統頁面（如上一頁或首頁）。
2. **Given** 使用者已在叫號系統頁面且已連線，**When** 點擊「結束」後，**Then** 使用者不再停留在叫號系統頁面。
3. **Given** 使用者尚未連線，**When** 點擊「返回」或等同離開入口，**Then** 仍可正常離開叫號系統頁面。

---

### User Story 2 - 叫號邏輯正確且可預期 (Priority: P1)

管理員使用叫號系統時，等待隊列的排序、叫號順序、分配至場地的人選與狀態應符合「先到先服務」或產品所定義的規則，且行為一致、可重現，無明顯錯號、漏號或狀態不同步。

**Why this priority**: 使用者指出「明顯的叫號 bug」，修正叫號邏輯是重新設計的核心目標。

**Independent Test**: 依序加入等待隊列、進行分配與結束比賽，重複數次並比對隊列順序與場地分配結果，可獨立驗證叫號與狀態是否正確。

**Acceptance Scenarios**:

1. **Given** 多人已加入等待隊列，**When** 系統進行自動或手動分配，**Then** 被叫上場的人選與順序符合既定規則（如依加入時間或號碼）。
2. **Given** 某場地比賽已結束，**When** 系統處理結束流程，**Then** 該場地狀態與等待隊列狀態正確更新，且所有連線中的客戶端所見一致。
3. **Given** 存在待確認的分配狀態，**When** 使用者確認或取消，**Then** 隊列與場地狀態一致更新，無殘留錯誤狀態。

---

### User Story 3 - 叫號會話結束時狀態清理完整 (Priority: P2)

當使用者透過「結束」或等同操作離開叫號系統時，系統應正確結束連線並清理該次會話相關狀態（如清空或重置隊列、釋放資源），以便下次進入時從乾淨狀態開始，或與後端狀態一致。

**Why this priority**: 避免因未清理導致下次進入出現舊資料或不一致，影響信任度與後續叫號正確性。

**Independent Test**: 在叫號進行中點擊「結束」離開，再次進入同一團隊叫號頁面，確認顯示與後端狀態一致、無殘留錯誤資料。

**Acceptance Scenarios**:

1. **Given** 使用者點擊「結束」離開叫號系統，**When** 後端處理結束請求，**Then** 該團隊的叫號會話狀態被正確清理或標記為結束。
2. **Given** 使用者已離開叫號頁面，**When** 再次進入叫號系統，**Then** 所見隊列與場地狀態與後端一致，無明顯殘留或錯亂。

---

### Edge Cases

- 使用者在「結束」請求送出但尚未完成導向時再次點擊「結束」或「返回」，系統應避免重複請求並仍能安全離開頁面。
- 網路中斷或逾時時，使用者點擊「結束」應仍能離開叫號系統頁面，必要時可先做本地斷線再導向。
- 多人同時操作同一團隊叫號時，任一人結束會話或離開，不應導致其他連線者看到未預期的錯誤畫面，其餘人應仍可正常使用或收到狀態更新。
- 等待隊列為空或所有場地皆空時，叫號邏輯與「結束」行為仍應正常運作，且離開後狀態一致。

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系統必須在使用者於叫號系統頁面點擊「結束」後，結束當前叫號連線並**直接離開叫號系統頁面**（導向上一頁或指定目標頁），不得僅斷線而仍停留在該頁。
- **FR-002**: 叫號順序與分配邏輯必須符合產品定義的規則（如依加入時間或號碼），且行為一致、可重現，無錯號、漏號或與規則不符的分配。
- **FR-003**: 場地比賽結束後，系統必須正確更新該場地與等待隊列的狀態，並將更新同步至所有連線中的客戶端，使各端所見一致。
- **FR-004**: 待確認的分配在使用者確認或取消後，系統必須正確更新隊列與場地狀態，不得留下錯誤或殘留的待確認狀態。
- **FR-005**: 當使用者透過「結束」離開叫號系統時，系統必須執行會話結束與狀態清理（如清空或重置該次會話的隊列與連線狀態），使下次進入時與後端狀態一致。
- **FR-006**: 系統必須提供明確的離開叫號系統入口（如「結束」或「返回」），且離開後使用者不再停留在叫號系統頁面。

### Key Entities

- **叫號會話**：一次使用者在叫號系統頁面的連線與操作週期；具連線狀態、等待隊列、場地分配狀態，結束時需清理。
- **等待隊列**：等候上場的成員列表；具順序與時間或號碼等屬性，供叫號與分配使用。
- **場地**：可分配人員進行比賽的單位；具分配狀態（空、待確認、進行中）、當前分配人員與比賽結束狀態。
- **分配**：將隊列成員對應至場地位置的關係；可為待確認或已確認，確認或取消時需更新隊列與場地。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 使用者在叫號系統頁面點擊「結束」後，於 2 秒內離開該頁面（導向完成），且不再顯示叫號系統內容。
- **SC-002**: 在典型操作下（依序加入隊列、分配、結束比賽），叫號與分配結果 100% 符合既定規則，且重複測試可重現相同邏輯。
- **SC-003**: 場地或隊列狀態更新後，所有連線中的客戶端在 3 秒內看到一致狀態，無明顯不同步或錯誤顯示。
- **SC-004**: 透過「結束」離開後再次進入叫號系統，使用者所見狀態與後端一致的比例達 100%，無因未清理導致的殘留或錯亂。
- **SC-005**: 支援與叫號相關的操作（加入隊列、分配、結束比賽、結束會話）在正常網路下完成率達 99% 以上，錯誤時有明確提示且不阻擋離開頁面。

## Assumptions

- 「結束」按鈕指目前叫號系統頁面中與連線狀態一併顯示的「結束」控制項（點擊後預期為結束連線並離開）。
- 離開叫號系統頁面指導向至上一頁或產品既定的入口（如團隊首頁、儀表板），不限定具體路徑，由實作決定。
- 叫號規則以「先到先服務」或依號碼/時間排序為預設，若產品另有明確規則則從其規定。
- 狀態同步依賴現有即時通訊機制（如 WebSocket），不變更既有架構前提下落實正確性與一致性即可。
